{% extends "layout.html" %} {% block main %}

<!-- 
page for drawing stuff on map, then save to db and redirect back to index with new shape 
-->

<h3 class="personal-space">Draw shape</h3>
<p>Tip: select drawing tool (on left) to start</p>

<!-- Map container -->
<div class="map-container">
  <!-- https://leafletjs.com/examples/quick-start/ -->
  <!-- map needs a height or it won't show -->
  <div id="map" style="height: 400px"></div>
</div>

<form id="saveShapeForm" method="POST" action="/saveshape">
  <input type="hidden" name="shape_name" value="{{ shape_name }}" />
  <input type="hidden" name="shape_type" value="{{ shape_type }}" />
  <input type="hidden" name="shape_color" value="{{ shape_color }}" />
  <input
    type="hidden"
    name="shape_parent_place_id"
    value="{{ shape_parent_place_id }}"
  />
  <input type="hidden" name="shape_category" value="{{ shape_category }}" />
  <input type="hidden" name="shape_notes" value="{{ shape_notes }}" />
  <input type="hidden" name="geometry" id="geometryInput" />

  <button type="submit" id="saveBtn" disabled>Save Shape</button>
  <a href="/">Cancel</a>
</form>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    try {
      // create leaflet map
      let map = L.map("map").setView([-27.47, 153.03], 10);

      // add map to page
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        // maxZoom: 19,
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(map);

      // TODO add places to map (shapes already added somehow?)

      let drawnItems = new L.FeatureGroup();
      map.addLayer(drawnItems);

      // don't need an event listener; L.Control.Draw() takes care of it
      let drawControl = new L.Control.Draw({
        edit: { featureGroup: drawnItems },
        draw: {
          polygon: {{ 'true' if shape_type == 'polygon' else 'false' }},
          polyline: {{ 'true' if shape_type == 'linestring' else 'false' }},
          rectangle: false, // {{ 'true' if shape_type == 'rectangle' else 'false' }},
          circle: false,
          marker: false, // TODO rethink which tool i want to use for point shapes
          circlemarker: {{ 'true' if shape_type == 'point' else 'false' }},
        },
      });
      map.addControl(drawControl);
      // TODO: comment/understand all this
      map.on("draw:created", function (e) {
        let layer = e.layer;
        drawnItems.addLayer(layer);

        // Extract geometry and enable save button
        let geometry = layer.toGeoJSON().geometry;
        document.getElementById("geometryInput").value =
          JSON.stringify(geometry);
        document.getElementById("saveBtn").disabled = false;
      });
    } catch (error) {
      console.error("Map error:", error);
    }
  });
</script>

{% endblock %}
